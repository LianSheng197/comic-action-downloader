<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Test</title>
</head>

<body>
    <script>
        (async function () {
            let pageData = await fetch(
                "https://cors-anywhere.herokuapp.com/https://comic-action.com/episode/13933686331617762163.json"
            ).then(
                r => r.json()
            ).then(
                j => j.readableProduct
            ).catch(
                e => "error"
            )

            if (pageData != "error") {
                // 成功取得資料

                if (pageData.isPublic == true) {
                    // 該篇爲公開

                    let seriesName = pageData.series.title;
                    let episodeName = pageData.title;
                    let count = 1;
                    let isStart = false;

                    downloadFromUrl(pageData.series.thumbnailUri, `${seriesName}_${episodeName}_0`);
                    pageData.pageStructure.pages.forEach(page => {
                        if (page.contentStart != undefined) {
                            // 開始
                            isStart = true;
                        }

                        if (isStart) {
                            rearrangeImage(page.src, `${seriesName}_${episodeName}_${count}`);
                            count++;

                            if(page.contentEnd != undefined){
                                // 結束
                                isStart = false;
                            }
                        }
                    });
                }
            }

            function rearrangeImage(imgUrl, filename) {
                const pw = 208;
                const ph = 296;

                let canvasResult = document.createElement('canvas');
                let ctxResult = canvasResult.getContext("2d");
                canvasResult.height = 1200;
                canvasResult.width = 844;

                let img = new Image();
                img.setAttribute('crossorigin', 'anonymous');
                img.onload = function () {

                    // 壓底圖
                    ctxResult.drawImage(img, 0, 0);

                    // 逐塊貼上 依序，反震旦方向對稱（對稱軸爲 1 6 11 16）
                    // 1  2  3  4
                    // 5  6  7  8
                    // 9  10 11 12
                    // 13 14 15 16

                    ctxResult.drawImage(img, pw * 1, ph * 0, pw, ph, pw * 0, ph * 1, pw, ph); // 2
                    ctxResult.drawImage(img, pw * 0, ph * 1, pw, ph, pw * 1, ph * 0, pw, ph); // 5

                    ctxResult.drawImage(img, pw * 2, ph * 0, pw, ph, pw * 0, ph * 2, pw, ph); // 3
                    ctxResult.drawImage(img, pw * 0, ph * 2, pw, ph, pw * 2, ph * 0, pw, ph); // 9

                    ctxResult.drawImage(img, pw * 3, ph * 0, pw, ph, pw * 0, ph * 3, pw, ph); // 4
                    ctxResult.drawImage(img, pw * 0, ph * 3, pw, ph, pw * 3, ph * 0, pw, ph); // 13

                    ctxResult.drawImage(img, pw * 2, ph * 1, pw, ph, pw * 1, ph * 2, pw, ph); // 7
                    ctxResult.drawImage(img, pw * 1, ph * 2, pw, ph, pw * 2, ph * 1, pw, ph); // 10

                    ctxResult.drawImage(img, pw * 3, ph * 1, pw, ph, pw * 1, ph * 3, pw, ph); // 8
                    ctxResult.drawImage(img, pw * 1, ph * 3, pw, ph, pw * 3, ph * 1, pw, ph); // 14

                    ctxResult.drawImage(img, pw * 3, ph * 2, pw, ph, pw * 2, ph * 3, pw, ph); // 12
                    ctxResult.drawImage(img, pw * 2, ph * 3, pw, ph, pw * 3, ph * 2, pw, ph); // 15

                    downloadFromCanvas(canvasResult, filename);
                }

                img.src = imgUrl;
            }

            function downloadFromCanvas(canvas, filename) {
                let link = document.createElement('a');
                link.download = `${filename}.png`;
                link.href = canvas.toDataURL()
                link.click();
            }

            function downloadFromUrl(url, filename) {
                let link = document.createElement('a');
                link.target = "_blank";
                link.download = `${filename}.png`;
                link.href = url;
                link.click();
            }
        })();
    </script>
</body>

</html>